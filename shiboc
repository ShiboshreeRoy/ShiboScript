#!/usr/bin/env python3
"""
ShiboScript Compiler - Real-world Python-like compiler implementation
"""

import sys
import os
import argparse
from pathlib import Path

# Add the src directory to the path so we can import shiboscript
sys.path.insert(0, os.path.join(os.path.dirname(__file__), 'src'))

from shiboscript.compiler import ShiboScriptCompiler
from shiboscript.core import run_file, repl, compile_file as core_compile_file, run_compiled_bytecode


def main():
    parser = argparse.ArgumentParser(
        prog='shiboc',
        description='ShiboScript Compiler - A Python-like scripting language compiler',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  shiboc script.shibo              # Compile script.shibo to Python
  shiboc -c script.shibo           # Compile to Python (.py)
  shiboc -b script.shibo           # Compile to bytecode (.sbc)
  shiboc -r script.shibo           # Run the script directly
  shiboc -o output.py script.shibo # Compile to specific output file
        """
    )
    
    parser.add_argument('file', nargs='?', help='Input ShiboScript file')
    parser.add_argument('-c', '--compile', action='store_true', 
                       help='Compile to Python (.py)')
    parser.add_argument('-b', '--bytecode', action='store_true', 
                       help='Compile to bytecode (.sbc)')
    parser.add_argument('-r', '--run', action='store_true', 
                       help='Run the file directly')
    parser.add_argument('-o', '--output', 
                       help='Specify output file name')
    parser.add_argument('-O', '--optimize', type=int, default=1,
                       help='Optimization level (0-2, default: 1)')
    parser.add_argument('--debug', action='store_true',
                       help='Enable debug output')
    parser.add_argument('-v', '--version', action='version',
                       version='ShiboScript Compiler 1.0.0')
    
    args = parser.parse_args()
    
    if not args.file:
        if args.run:
            # Start REPL if no file provided with run flag
            from shiboscript.core import repl
            repl()
        else:
            parser.print_help()
            sys.exit(1)
    
    if not os.path.exists(args.file):
        print(f"Error: File '{args.file}' does not exist.")
        sys.exit(1)
    
    if args.run:
        # Run the file directly through the interpreter
        run_file(args.file)
    elif args.bytecode:
        # Compile to bytecode
        import pickle
        bytecode = core_compile_file(args.file)
        output_file = args.output or args.file.replace('.shibo', '.sbc')
        with open(output_file, 'wb') as f:
            f.write(pickle.dumps(bytecode))
        print(f"Compiled to bytecode: {output_file}")
    else:
        # Default to compiling to Python
        from shiboscript.compiler import ShiboCompiler
        compiler = ShiboCompiler()
        with open(args.file, 'r') as f:
            code = f.read()
        python_code = compiler.compile_to_python(code)
        output_file = args.output or args.file.replace('.shibo', '.py')
        with open(output_file, 'w') as f:
            f.write('#!/usr/bin/env python3\n')
            f.write('# Generated by ShiboScript Compiler\n')
            f.write('# Source: ' + args.file + '\n\n')
            f.write(python_code)
        print(f"Compiled to Python: {output_file}")
        
        # Optionally run the compiled Python file
        if args.run:
            import subprocess
            subprocess.run([sys.executable, output_file])


if __name__ == "__main__":
    main()